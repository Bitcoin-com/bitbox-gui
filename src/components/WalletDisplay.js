import React, { Component } from 'react';
import BitcoinCash from '../utilities/BitcoinCash';
import Crypto from '../utilities/Crypto';
import AddressDetails from './AddressDetails';
import underscore from 'underscore';

class WalletDisplay extends Component {
  render() {
    let list = [];
    if (this.props.addresses.length) {
      this.props.addresses.forEach((address, index) => {
        // get balances
        let publicKey = BitcoinCash.fromWIF(address.privateKeyWIF, this.props.wallet.network).getAddress();
        let ripemd160 = Crypto.createRIPEMD160Hash(publicKey);

        let outputs = [];
        underscore.each(this.props.utxoSet.outputs, (output, index) => {
          if(output.address === publicKey) {
            outputs.push(output);
          }
        });
        // let outputs = underscore.where(this.props.utxoSet, {address: publicKey});
        let balance = 0;
         underscore.each(outputs, (output, index) => {
           balance += output.value;
         });

        // get transactions
        let transactions = [];
        underscore.each(this.props.blockchainInstance.chain, (block, index) => {
          underscore.each(block.transactions, (transaction, index) => {
            transactions.push(underscore.where(transaction.inputs, {ripemd160: ripemd160}));
            transactions.push(underscore.where(transaction.outputs, {ripemd160: ripemd160}));
          });
        });

        let transactionsCount = 0;
        underscore.each(transactions, (transaction, index) => {
          transactionsCount += transaction.length;
        });

        list.push(
          <AddressDetails
            address={address}
            index={index}
            key={index}
            balance={balance}
            transactionsCount={transactionsCount}
            displayCashaddr={this.props.displayCashaddr}
            wallet={this.props.wallet}
          />
        );
      });
    }

    return (
      <div className="WalletDisplay content pure-g">
        <div className="pure-u-1-1">
          <ul className='subheader'>
            <li className=''>MNEMONIC</li>
            <li className='right'>HD PATH</li>
          </ul>
          <ul className='subheader'>
            <li className='content-head'>{this.props.mnemonic}</li>
            <li className='content-head right'>{this.props.path.replace(/\/$/, "")}/account_index&rsquo;</li>
          </ul>
          <table className="pure-table">
            <tbody>
              {list}
            </tbody>
          </table>
        </div>
      </div>
    );
  }
}

export default WalletDisplay;
